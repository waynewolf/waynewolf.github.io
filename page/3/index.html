<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="blog" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta property="og:type" content="website">
<meta property="og:title" content="Wayne&#39;s Blog">
<meta property="og:url" content="http://waynewolf.github.io/page/3/index.html">
<meta property="og:site_name" content="Wayne&#39;s Blog">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Wayne&#39;s Blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"right","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://waynewolf.github.io/page/3/"/>





  <title>Wayne's Blog</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-right 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Wayne's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Spend life on wonderful things</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://waynewolf.github.io/2014/06/22/surfaceflinger-and-client/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wayne Wolf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wayne's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/06/22/surfaceflinger-and-client/" itemprop="url">surfaceflinger and client</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-06-22T18:43:49+08:00">
                2014-06-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>SurfaceFlinger is the composition and display manager of android, it mainly plays two roles in the system:</p>
<ul>
<li>Surface composition</li>
<li>Buffer allocation on behalf of clients, interacts with clients through Binder interface</li>
</ul>
<p>This article is based on KitKat 4.4.2.</p>
<h2 id="How-client-draws-UI"><a href="#How-client-draws-UI" class="headerlink" title="How client draws UI"></a>How client draws UI</h2><p>ISurfaceComposer is the interface to talk to SurfaceFlinger, there’re two ways to get ISurfaceComposer interface in Client:</p>
<pre><code>sp&lt;ISurfaceComposer&gt; composer;
composer = ComposerService::getComposerService();
</code></pre><p>or</p>
<pre><code>getService(&quot;SurfaceFlinger&quot;, &amp;composer);
</code></pre><p>ISurfaceComposerClient is the interface to create Surface. To get ISurfaceComposerClient interface, use the ISurfaceComposer instance returned above:</p>
<pre><code>sp&lt;ISurfaceComposerClient&gt; composerClient = composer-&gt;createConnection();
</code></pre><p>The above two methods can be combined in single step:</p>
<pre><code>sp&lt;SurfaceComposerClient&gt; composerClient = new SurfaceComposerClient;
</code></pre><p>To operate on Surface, you have to get SurfaceControl first, simply call createSurface on the SurfaceComposerClient instance:</p>
<pre><code>sp&lt;SurfaceControl&gt; surfaceControl = composerClient-&gt;createSurface();
</code></pre><p>And call getSurface on SurfaceControl instance, you can finally get Surface:</p>
<pre><code>sp&lt;Surface&gt; surface = surfaceControl-&gt;getSurface();
</code></pre><p>Get buffer to draw:</p>
<pre><code>int Surface::lock(ANativeWindow_Buffer* outBuffer, ARect* inOutDirtyBounds);
</code></pre><p>Draw on surface with whatever method you want.</p>
<p>Complete drawing by calling:</p>
<pre><code>int Surface::unlockAndPost();
</code></pre><p>If some operations need atomic transaction, just wrap them inside:</p>
<pre><code>SurfaceComposerClient::openGlobalTransaction();
...
SurfaceComposerClient::closeGlobalTransaction();
</code></pre><h2 id="BufferQueue-and-Consumer-Provider"><a href="#BufferQueue-and-Consumer-Provider" class="headerlink" title="BufferQueue and Consumer/Provider"></a>BufferQueue and Consumer/Provider</h2><p>BufferQueue plays a central role in GraphicBuffer exchange process, two roles which are consumer and provider are designed to distinguish different entity and intension.<br>The producer of a BufferQueue can</p>
<pre><code>queueBuffer
dequeueBuffer
</code></pre><p>The consumer of a BufferQueue can</p>
<pre><code>acquireBuffer
releaseBuffer
</code></pre><p>Back to BufferQueue, usually client application create Surface, it’s provider end of a BufferQueue, SurfaceFlinger acts as consumer of the Surface provided by client. However, SurfaceFlinger also acts as provider as regard to FrameBufferSurface, which is consumed by display.</p>
<p>These APIs support android native sync to manage concurrency. Android native sync is introduced in 4.x.x. It’s a framework used by native code, while at the same time, graphic drivers haver to implement correspondance interface. Android sync is out of the scope of this article.</p>
<h2 id="Drawing-a-frame"><a href="#Drawing-a-frame" class="headerlink" title="Drawing a frame"></a>Drawing a frame</h2><h3 id="General-flow"><a href="#General-flow" class="headerlink" title="General flow"></a>General flow</h3><pre>
handleMessageRefresh
     |—> preComposition
     |—> rebuildLayerStacks
     |—> setUpHWComposer
          |—> HWComposer::createWorkList <== hwc="" structures="" are="" allocated="" |—=""> Layer::setGeometry()
          |—  set per frame data
          |—  HWComposer::prepare
               |—> hwc prepare
     |—> doComposition
          |---- skip composition on external display if condition meets
          |—> doDisplayComposition
          |    |—> doComposeSurfaces
          |     |—> DisplayDevice::swapBuffers
          |          |—> eglSwapBuffers
          |          |—> FramebufferSurface::advanceFrame
          |—> DisplayDevice::flip(…)     <== just="" update="" statistics="" count="" |--=""> Call DisplayDevice::compositionComplete(), notify each display
               |--> DisplaySurface::compositionComplete()
                    |--> FramebufferSurface::compositionComplete()
                         |--> HWComposer::fbCompositionComplete()
                              |--> NoOP if HWC >= 1.1
                              |--> used only in framebuffer device case.
          |—> postFrameBuffer
               |—> HWComposer::commit
                    |—> hwc set
                    |—> update retireFenceFd of hwc_display_contents_1
               |—> DisplayDevice::onSwapBuffersCompleted
                    |—> FramebufferSurface::onFrameComitted
               |—> Layer::onLayerDisplayed
               |—   update some statistics
     |—> postComposition 
</==></==></pre>

<h3 id="doComposeSurfaces"><a href="#doComposeSurfaces" class="headerlink" title="doComposeSurfaces"></a>doComposeSurfaces</h3><p>handleMessageRefresh -&gt; doComposition -&gt; doDisplayComposition -&gt; doComposeSurfaces</p>
<ul>
<li>Preparation work: <ul>
<li>If GLES and hwc compositing, clear frame buffer target first </li>
<li>If GLES only, drawWarmHole first</li>
</ul>
</li>
<li>Render layers to framebuffer<ul>
<li>For all layers if using hwc<ul>
<li>do nothing if HWC_OVERLAY layer, display hardware will blend the layer</li>
<li>render with opengl if HWC_FRAMEBUFFER layer, call layer-&gt;draw()</li>
<li>set the layer’s acquireFence</li>
</ul>
</li>
<li>For all layers if no hwc<ul>
<li>just render with OpenGL, call layer-&gt;draw()</li>
</ul>
</li>
</ul>
</li>
<li>Now all the GLES layers are drawn on frame buffer target, waiting to swapBuffers</li>
</ul>
<p>HWC related topic will be written in another article.</p>
<h3 id="How-FrameBufferSurface-and-eglSwapBuffers-interact"><a href="#How-FrameBufferSurface-and-eglSwapBuffers-interact" class="headerlink" title="How FrameBufferSurface and eglSwapBuffers interact"></a>How FrameBufferSurface and eglSwapBuffers interact</h3><p>In SurfaceFlinger::init, the mDisplaySurface in DisplayDevice comes from the same BufferQueue as EGLSurface, look at the code </p>
<pre><code>bq = new BufferQueue(new GraphicBufferAlloc());
fbs = new FramebufferSurface(…, bq);
hw = new DisplayDevice(…, fbs, bq, …);
mDisplays.add(…,hw);
</code></pre><p>So now EGL can swap to the FrameBufferSurface, because the EGLSurface is the provider end of the same BufferQueue which hosts FrameBufferSurface.<br>The layer represented by the frame buffer target is tracked by DisplayDevice::framebufferTarget, ANativeWindow and ANativeWindowBuffer is the interface used by EGL to access the buffer allocated in SurfaceFlinger. Basically flow is:</p>
<p>swap to DisplayDevice::mSurface, DisplayDevice::mNativeWindow influenced too -&gt; BufferQueue::queueBuffer -&gt; FramebufferSurface::onFrameAvailable -&gt; HWComposer::fbPost -&gt; HWComposer::setFramebufferTarget -&gt; get framebuffer target fram handle parameter -&gt; disp.framebufferTarget.handle = disp.fbTargetHandle;</p>
<pre><code>Stack trace: FramebufferSurface::onFrameAvailable (24 frames)
...
#02  pc 0002dffa  /system/lib/libgui.so (android::BufferQueue::ProxyConsumerListener::onFrameAvailable()+74)
#03  pc 00030ca9  /system/lib/libgui.so (android::BufferQueue::queueBuffer(int, android::IGraphicBufferProducer::QueueBufferInput const&amp;, android::IGraphicBufferProducer::QueueBufferOutput*)+2425)
#04  pc 000481cf  /system/lib/libgui.so (android::Surface::queueBuffer(ANativeWindowBuffer*, int)+559)
#05  pc 000470c9  /system/lib/libgui.so (android::Surface::hook_queueBuffer(ANativeWindow*, ANativeWindowBuffer*, int)+41)
...
#17  pc 0001e895  /system/lib/libutils.so (android::Looper::pollOnce(int, int*, int*, void**)+53)
#19  pc 00022a67  /system/lib/libsurfaceflinger.so (android::SurfaceFlinger::run()+39)
...
#22  pc 00000a02  /system/bin/surfaceflinger
</code></pre><p>To get clear understanding of the process and the role, reference to this picture:</p>
<p><img src="/images/post/surfaceflinger-as-consumer-and-producer.png" alt="surfaceflinger as consumer and producer"></p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><ol>
<li>Surface dequeueBuffer eventually works on BuffferQueue in SF, Surface is provider, SurfaceFlingerConsumer is consumer</li>
<li>GraphicBuffer in allocated for Surface to draw.</li>
<li>Surface queueBuffer eventually works on BufferQueue in SF, Layer::onFrameAvailable called.</li>
<li>SurfaceFlingerConsumer::updateTexImage bind EGLImage as texture</li>
<li>Layer::onDraw draws to the BufferQueue of FramebufferSurface, here egl is provider, FramebufferSurface is consumer</li>
<li>FramebufferSurface::onFrameAvailable -&gt; HWComposer::fbPost -&gt; HWComposer::setFramebufferTarget</li>
<li>All layers prepared, sent to HWC</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://waynewolf.github.io/2014/05/17/eglimage-in-surfaceflinger/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wayne Wolf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wayne's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/05/17/eglimage-in-surfaceflinger/" itemprop="url">eglimage in surfaceflinger</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-05-17T20:01:55+08:00">
                2014-05-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>In android, the application UI is used as an OpenGL ES texture, and composed by SurfaceFlinger to form final image on display. To understand how the application UI is sent to OpenGL, we have to start from some egl/oes extensions.</p>
<h2 id="EGL-KHR-image-base-amp-EGL-KHR-image"><a href="#EGL-KHR-image-base-amp-EGL-KHR-image" class="headerlink" title="EGL_KHR_image_base &amp; EGL_KHR_image"></a>EGL_KHR_image_base &amp; EGL_KHR_image</h2><p>The spec says:</p>
<blockquote>
<p>This extension defines a new EGL resource type that is suitable for<br>sharing 2D arrays of image data between client APIs, the EGLImage.<br>Although the intended purpose is sharing 2D image data, the<br>underlying interface makes no assumptions about the format or<br>purpose of the resource being shared, leaving those decisions to<br>the application and associated client APIs.</p>
</blockquote>
<p>This extension is used to share buffers between different client APIs. EGLImage is an opaque handle to a shared resource, presumably a 2D array of image data.</p>
<p>EGL allows sharing context from the same client API (like OpenGL ES), however, in some cases, it may be desireable to share state between different client APIs(OpenGL ES &lt;-&gt; OpenVG). EGLImage is introduced to address this kind of complicated use cases.</p>
<p>EGL can create EGL resources that can be shared between contexts of different client APIs from client API resources like texel arrays in OpenGL ES texture objects. The client API resources called EGLImage source. In contrast, the client API can also create resources from EGLImage, and the created resources are called EGLImage target. Refer to spec for more concepts like EGLImage sibling.</p>
<p>New Types added:</p>
<pre><code>typedef void* EGLImageKHR;
</code></pre><p>New Procedures and Functions:</p>
<pre><code>EGLImageKHR eglCreateImageKHR(
                EGLDisplay dpy,
                EGLContext ctx,
                EGLenum target,
                EGLClientBuffer buffer,
                const EGLint *attrib_list)

EGLBoolean eglDestroyImageKHR(
                EGLDisplay dpy,
                EGLImageKHR image)
</code></pre><p>Please reference <a href="https://www.khronos.org/registry/egl/extensions/KHR/EGL_KHR_image_base.txt" target="_blank" rel="noopener">EGL_KHR_image_base</a> for more detailed explanation.</p>
<h2 id="OES-EGL-image"><a href="#OES-EGL-image" class="headerlink" title="OES_EGL_image"></a>OES_EGL_image</h2><p>The spec says:</p>
<blockquote>
<p>This extension provides a mechanism for creating texture and renderbuffer objects sharing storage with specified EGLImage objects.<br>The companion EGL_KHR_image_base and EGL_KHR_image extensions provide the definition and rationale for EGLImage objects.</p>
</blockquote>
<p>This extension allows EGLImage turned into a texture.</p>
<p>New type added:</p>
<pre><code>typedef void* GLeglImageOES;
</code></pre><p>New Procedures and Functions added:</p>
<pre><code>void EGLImageTargetTexture2DOES(enum target, eglImageOES image)
void EGLImageTargetRenderbufferStorageOES(enum target, eglImageOES image)
</code></pre><p>glEGLImageTargetTexture2DOES serves the same purpose as the well known glTexImage2D, but supporting EGLImage. </p>
<p>Please reference <a href="https://www.khronos.org/registry/gles/extensions/OES/OES_EGL_image.txt" target="_blank" rel="noopener">OES_EGL_image</a> for more detailed explanation.</p>
<h2 id="OES-EGL-image-external"><a href="#OES-EGL-image-external" class="headerlink" title="OES_EGL_image_external"></a>OES_EGL_image_external</h2><p>The spec says:</p>
<blockquote>
<p>This extension provides a mechanism for creating EGLImage texture targets<br>from EGLImages.  This extension defines a new texture target,<br>TEXTURE_EXTERNAL_OES.  This texture target can only be specified using an<br>EGLImage.</p>
</blockquote>
<p>This extension defines a new texture target TEXTURE_EXTERNAL_OES, GLSL can use new type samplerExternalOES to sample the external texture. This extension depends on EGL_KHR_image_base or EGL_KHR_image.</p>
<p>GLSL sampler type added:</p>
<pre><code>samplerExternalOES (when #extension GL_OES_EGL_image_external is used)
</code></pre><p>Despite the new texture target and sampler type, the intension of this extension is not clear until reading through the spec carefully. I guess the main purpose of this extension is allow driver to support color space converter. The spec says:</p>
<blockquote>
<p>Sampling an external texture will return an RGBA vector in the same<br>colorspace as the source image.  If the source image is stored in YUV<br>(or some other basis) then the YUV values will be transformed to RGB<br>values. (But these RGB values will be in the same colorspace as the<br>original image.  Colorspace here includes the linear or non-linear<br>encoding of the samples. For example, if the original image is in the<br>sRGB color space then the RGB value returned by the sampler will also<br>be sRGB, and if the original image is stored in ITU-R Rec. 601 YV12<br>then the RGB value returned by the sampler will be an RGB value in the<br>ITU-R Rec. 601 colorspace.) The parameters of the transformation<br>from one basis (e.g.  YUV) to RGB (color conversion matrix, sampling<br>offsets, etc) are taken from the EGLImage which is associated with the<br>external texture.  The implementation may choose to do this<br>transformation when the external texture is sampled, when the external<br>texture is bound, or any other time so long as the effect is the same.<br>It is undefined whether texture filtering occurs before or after the<br>transformation to RGB.</p>
</blockquote>
<p>This extension doesn’t support mipmap. The spec says:</p>
<blockquote>
<p>Calling GenerateMipmaps with <target> set to TEXTURE_EXTERNAL_OES results in an INVALID_ENUM</target></p>
</blockquote>
<p>In short, 3D driver is required to implement this color space transformation depending on the EGLImage format. Please reference <a href="https://www.khronos.org/registry/gles/extensions/OES/OES_EGL_image_external.txt" target="_blank" rel="noopener">OES_EGL_image_external</a> for more detailed explanation.</p>
<h2 id="Android-Usage"><a href="#Android-Usage" class="headerlink" title="Android Usage"></a>Android Usage</h2><p>In android, a specific target EGL_NATIVE_BUFFER_ANDROID is used in eglCreateImageKHR, to create EGLImage from ANativeWindowBuffer.</p>
<pre><code>eglCreateImageKHR(eglDisplay, EGL_NO_CONTEXT, EGL_NATIVE_BUFFER_ANDROID,
    (EGLClientBuffer)&amp;sSrcBuffer,0);
glGenTextures(1,&amp;texID);
glBindTexture(GL_TEXTURE_2D,texID);
glEGLImageTargetTexture2DOES(GL_TEXTURE_2D,eglSrcImage);
</code></pre><p>If the format of EGLClientBuffer is YUV, the texture target must be GL_TEXTURE_EXTERNAL_OES. This texture target, as explained early, can only be used in glEGLImageTargetTexture2DOES. It’s illegal to use this in gl<em>Tex</em>Image*() functions.</p>
<p>This is how OpenGL ES supports YUV format texture, the transformation work is offloaded to EGLImage in egl driver.</p>
<h2 id="Appendix"><a href="#Appendix" class="headerlink" title="Appendix"></a>Appendix</h2><p>All kinds of buffers across the graphic stack:</p>
<p><img src="/images/post/all-kinds-of-buffers.png" alt="all-kinds-of-buffers" title="all kinds of buffers"></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ol>
<li><a href="https://www.khronos.org/registry/egl/extensions/KHR/EGL_KHR_image_base.txt" target="_blank" rel="noopener">https://www.khronos.org/registry/egl/extensions/KHR/EGL_KHR_image_base.txt</a></li>
<li><a href="https://www.khronos.org/registry/gles/extensions/OES/OES_EGL_image.txt" target="_blank" rel="noopener">https://www.khronos.org/registry/gles/extensions/OES/OES_EGL_image.txt</a></li>
<li><a href="https://www.khronos.org/registry/gles/extensions/OES/OES_EGL_image_external.txt" target="_blank" rel="noopener">https://www.khronos.org/registry/gles/extensions/OES/OES_EGL_image_external.txt</a></li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://waynewolf.github.io/2014/01/11/how-binder-transfer-fd-across-process-boundary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wayne Wolf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wayne's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/01/11/how-binder-transfer-fd-across-process-boundary/" itemprop="url">how binder transfer fd across process boundary</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-01-11T20:20:45+08:00">
                2014-01-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>Android ashmem can map file descriptor to share memory across process boundary. Android binder help transfer fds between different processes, this is very basic and important infrastructure for graphic buffer sharing in android. However, fd cannot be sent across processes by socket without extra code, how does binder do this?</p>
<h2 id="Principle"><a href="#Principle" class="headerlink" title="Principle"></a>Principle</h2><p>fd cannot be shared between processes, but kernel <code>struct file *</code> pointer can.</p>
<h2 id="Sample-Code"><a href="#Sample-Code" class="headerlink" title="Sample Code"></a>Sample Code</h2><pre><code>struct file *file = fget(fd_in_process_a);
int fd_in_process_b = task_get_unused_fd_flags(target_proc, O_CLOEXEC);
task_fd_install(target_proc, fd_in_process_b, file);
</code></pre><p>The second process(target_proc) installs the fd, which is associated with <code>struct file *</code> used in the first process.</p>
<h2 id="Alternatives"><a href="#Alternatives" class="headerlink" title="Alternatives"></a>Alternatives</h2><ol>
<li>sendmsg/recvmsg only on unix domain socket,  cmsg_type set to SCM_RIGHTS，additional permission needed.</li>
<li>stream based pipe, ioctl I_SENDFD, seems deprecated on Linux, not sure.</li>
</ol>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference:"></a>Reference:</h2><p><a href="http://infohost.nmt.edu/~eweiss/222_book/222_book/0201433079/ch17lev1sec4.html" target="_blank" rel="noopener">http://infohost.nmt.edu/~eweiss/222_book/222_book/0201433079/ch17lev1sec4.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://waynewolf.github.io/2013/10/10/android-native-code-dump-stack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wayne Wolf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wayne's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2013/10/10/android-native-code-dump-stack/" itemprop="url">android native code dump stack</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2013-10-10T19:19:24+08:00">
                2013-10-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <pre>
#include <corkscrew backtrace.h="">
void dumpStack(const char *const msg)
{
#define MAX_FRAMES 16
#define MAX_LINE 256
#define IGNORE_DEPTH 1
    backtrace_frame_t frames[MAX_FRAMES];
    backtrace_symbol_t symbols[MAX_FRAMES];
    int nframes, i;
    char bt_line[MAX_LINE];

    nframes = unwind_backtrace(frames, IGNORE_DEPTH, MAX_FRAMES);
    if (nframes > 0)
    {
        ALOGD("Stack trace: %s (%d frames)", msg, nframes);
        get_backtrace_symbols(frames, nframes, symbols);

        for (i = 0; i < nframes; i++)
        {
            format_backtrace_line(i, &frames[i], &symbols[i], bt_line, MAX_LINE);
            ALOGD(" %s", bt_line);
        }

        ALOGD("End of stack trace");
    }
    else
    {
        ALOGD("Stack trace unwinding failed: %s", msg);
    }
}
</corkscrew></pre>

<p>link libcorkscrew in Android.mk</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://waynewolf.github.io/2013/05/30/transform-normal-to-eye-space/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wayne Wolf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wayne's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2013/05/30/transform-normal-to-eye-space/" itemprop="url">transform normal to eye space</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2013-05-30T10:50:50+08:00">
                2013-05-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>Vertex position coordinates can be transformed from object space to eye space using model-view matrix. However, normals can not be transformed in that way.</p>
<p>The two pictures shows what happened if we transform normal using model-view matrix:<br><img src="/images/post/transform-normal.gif" alt="transform normal" title="transform normal using model view matrix"></p>
<p>In eye space, tangent direction is correct, but normal is not perpendicular to tangent. Why is that happening?</p>
<h2 id="Why"><a href="#Why" class="headerlink" title="Why"></a>Why</h2><p>The math equation can explain it easily. Assume T is tangent, MV is model-view matrix. P1, P2 are two vertices used to calculate tangent.</p>
<pre><code>T = P2 - P1
T&apos; = T * MV = (P2 - P1) * MV = P2 * MV - P1 * MV = P2&apos; - P1&apos;
</code></pre><p>　　</p>
<p>T’ keeps tangent attributes, while normal does’t. You can find point Q1, Q2 to let N=Q2-Q1, after transformation, Q2’-Q1’ is not perpendicular to T’. The angle relationship doesn’t retain after object space to view space transformation.</p>
<h2 id="How-to-transform-normal"><a href="#How-to-transform-normal" class="headerlink" title="How to transform normal"></a>How to transform normal</h2><p>We need to calculate normal transformation from object to eye space, after which the transformed normal is still perpendicular to transformed tangent.<br>Assume the normal transformation is G, model view transformation is V, normal is perpendicular to tangent, so</p>
<pre><code>N&apos;.T&apos; = (GN).(VT) = 0
</code></pre><p>Vector dot product written as matrix multiplication:</p>
<p>(GN).(VT) = (GN)<sup>T</sup>(VT) =  (N<sup>T</sup>G<sup>T</sup>)(VT) = N<sup>T</sup>G<sup>T</sup>VT = 0</p>
<p>Notice that N<sup>T</sup>T is 0(N is perpendicular to T, so N.T = 0, hence N<sup>T</sup>T ＝ 0), if G<sup>T</sup>V = I, above equation is true, so G=(V<sup>-1</sup>)<sup>T</sup>. G equals to V only when V(model-view matrix) is orthogonal.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>normal matrix is the transpose of inverse model-view matrix, this is a very important conslusion that you should remember, because it is often used when calculating lighting.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="Wayne Wolf" />
          <p class="site-author-name" itemprop="name">Wayne Wolf</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/waynewolf" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/u/5658622153" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                    
                      Weibo
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-block">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://hexo.io/" title="Hexo" target="_blank">Hexo</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.sina.com.cn" title="Sina" target="_blank">Sina</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.facebook.com" title="Facebook" target="_blank">Facebook</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2013 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Wayne Wolf</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
