<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="blog" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta property="og:type" content="website">
<meta property="og:title" content="Wayne&#39;s Blog">
<meta property="og:url" content="http://waynewolf.github.io/index.html">
<meta property="og:site_name" content="Wayne&#39;s Blog">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Wayne&#39;s Blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"right","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://waynewolf.github.io/"/>





  <title>Wayne's Blog</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-right 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Wayne's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Spend life on wonderful things</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://waynewolf.github.io/2018/01/06/tensorflow-4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wayne Wolf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wayne's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/06/tensorflow-4/" itemprop="url">tensorflow 4</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-06T21:29:04+08:00">
                2018-01-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="finetune-for-object-detection"><a href="#finetune-for-object-detection" class="headerlink" title="finetune for object detection"></a>finetune for object detection</h1><p>tensorflow 仓库里有 object detection API，不过我并不打算用，在我看来，使用它会降低将来部署模型的灵活性，不如自己写。这里把过程记录下来。</p>
<h2 id="下载预训练模型"><a href="#下载预训练模型" class="headerlink" title="下载预训练模型"></a>下载预训练模型</h2><p>Mobilenet/SSD or ResNet101/SSD ?</p>
<h2 id="准备数据层"><a href="#准备数据层" class="headerlink" title="准备数据层"></a>准备数据层</h2><h2 id="调整模型"><a href="#调整模型" class="headerlink" title="调整模型"></a>调整模型</h2><h2 id="完善评估和训练代码"><a href="#完善评估和训练代码" class="headerlink" title="完善评估和训练代码"></a>完善评估和训练代码</h2><h2 id="开始训练"><a href="#开始训练" class="headerlink" title="开始训练"></a>开始训练</h2><h2 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h2>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://waynewolf.github.io/2018/01/06/tensorflow-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wayne Wolf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wayne's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/06/tensorflow-3/" itemprop="url">tensorflow 3</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-06T21:23:07+08:00">
                2018-01-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="制作-TFRecord"><a href="#制作-TFRecord" class="headerlink" title="制作 TFRecord"></a>制作 TFRecord</h1><h1 id="DataSet-API"><a href="#DataSet-API" class="headerlink" title="DataSet API"></a>DataSet API</h1><h1 id="TF-Slim"><a href="#TF-Slim" class="headerlink" title="TF Slim"></a>TF Slim</h1><p>TF Slim 的 <a href="https://github.com/tensorflow/tensorflow/tree/master/tensorflow/contrib/slim" target="_blank" rel="noopener">API</a> 文档已经介绍的很清楚了，无需赘言。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://waynewolf.github.io/2018/01/06/tensorflow-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wayne Wolf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wayne's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/06/tensorflow-2/" itemprop="url">tensorflow 2 </a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-06T20:56:00+08:00">
                2018-01-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="TF-Mobile-和-TF-Lite"><a href="#TF-Mobile-和-TF-Lite" class="headerlink" title="TF Mobile 和 TF Lite"></a>TF Mobile 和 TF Lite</h1><p>目前 TF Lite 还没有成熟，代码中散落各类实现和例子，有必要先了解一下两个相近的框架 TF Mobile 和 TF Lite。TF Mobile 早于 TF Lite，是Tensorflow最初在移动设备上的移植，它没有硬件加速，没有量化等优化，因此可以认为它是一个过度框架。而 TF Lite 实现了比 protobuf 更轻量级的 flatbuffer，开销小，但目前不是所有的 op 都支持。总之，能用 TF Lite 的地方就尽量用，不能用再考虑 TF Mobile。</p>
<h2 id="TF-Mobile-demo-analysis"><a href="#TF-Mobile-demo-analysis" class="headerlink" title="TF Mobile demo analysis"></a>TF Mobile demo analysis</h2><p>TF Mobile Camera 例子涵盖最基础的四个应用场景，classification, detection, stylize 和 sppech。<br>org.tensorflow.demo java库，主要API：</p>
<ul>
<li>TensorFlowInferenceInterface</li>
</ul>
<p>如何使用这个类可以参考<a href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/examples/android/src/org/tensorflow/demo/TensorFlowImageClassifier.java" target="_blank" rel="noopener">TensorFlowImageClassifier.java</a></p>
<p>java 程序如果想用 tensorflow，可以使用 jcenter 仓库中的版本，在 build.gradle 加上如下几行即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    compile &apos;org.tensorflow:tensorflow-android:+&apos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>java apk依赖两个c++ 库：</p>
<ul>
<li>libtensorflow_demo.so</li>
<li>libtensorflow_inference.so</li>
</ul>
<p>其中 libtensorflow_demo.so 做 RGB-&gt;YUV转换，并不重要。而 libtensorflow_inference.so 是 tensorflow C++库，<br>有必要搞明白它怎么来的，便于以后自己编译。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cd $TF_REPO_ROOT</span><br><span class="line">$ bazel build -c opt //tensorflow/contrib/android:libtensorflow_inference.so \</span><br><span class="line">     --crosstool_top=//external:android/crosstool \</span><br><span class="line">     --host_crosstool_top=@bazel_tools//tools/cpp:toolchain \</span><br><span class="line">     --cpu=armeabi-v7a</span><br></pre></td></tr></table></figure>
<p>把cpu替换成自己需要的架构。更详细信息参考<a href="https://github.com/tensorflow/tensorflow/tree/master/tensorflow/contrib/android" target="_blank" rel="noopener">这里</a></p>
<p>要看demo效果，可以直接使用 nightly build 的demo，也可以用 android studio 打开 tensorflow/examples/android 目录进行编译。参考<a href="https://github.com/tensorflow/tensorflow/tree/master/tensorflow/examples/android" target="_blank" rel="noopener">这里</a></p>
<h2 id="TF-Lite-demo"><a href="#TF-Lite-demo" class="headerlink" title="TF Lite demo"></a>TF Lite demo</h2><p>TF lite的例子中依然用到 tensorflow.aar 包，包含 libtensorflow_inference.so, libtensorflow_demo.so，它们是怎么来的，什么作用？</p>
<p>代码目录</p>
<ul>
<li>tensorflow/contrib/lite/java/demo</li>
</ul>
<p>java包:</p>
<ul>
<li>org.tensorflow.lite.Interpreter</li>
</ul>
<p>使用 jcenter 中的 tensorflow.aar 报，包含：</p>
<ul>
<li>libtensorflowlite_jni.so (实现: tensorflow/contrib/lite/java/src/main/native)</li>
<li>libtensorflow_inference.so (实现：tensorflow/contrib/android)</li>
</ul>
<h2 id="tensorflow-lite-c-库"><a href="#tensorflow-lite-c-库" class="headerlink" title="tensorflow-lite c++ 库"></a>tensorflow-lite c++ 库</h2><p>google 非常贴心地在 tensorflow 代码库中加入了 tensorlow-lite android apk, 运行起来豪不费劲，不过我更关心 tensorflow-lite 在嵌入式设备上的推断运行，以及在新场景下的finetune模型。</p>
<p>自带的 tensorflow camera 例子，调用路径是 java -&gt; libtensorflow_jni.so，而我需要的是把 tensorflowlite 的cpp库，所以需要从头开始编译。</p>
<p>用如下方式编译：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cd $TF_ROOT</span><br><span class="line"># bazel build -c opt //tensorflow/contrib/lite:*</span><br></pre></td></tr></table></figure>
<p>产生如下几个库，静态和动态都有：</p>
<ul>
<li>libcontext.{a,so}</li>
<li>libframework.{a,so}</li>
<li>libstring_util.{a,so}</li>
</ul>
<p>其实 tensorflow camera demo 的java代码使用的 libtensorflowlite_jni.so，就是把这几个静态库打包起来。</p>
<p>接下来就可以使用tensorflow-lite c++接口了，接口文档在<a href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/contrib/lite/g3doc/apis.md" target="_blank" rel="noopener">这里</a></p>
<h2 id="Go-through-TF-Lite-finetune-process"><a href="#Go-through-TF-Lite-finetune-process" class="headerlink" title="Go through TF Lite finetune process"></a>Go through TF Lite finetune process</h2><p><strong>Download pretrained TF Slim model</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ export MODEL_DIR=/path/to/your/model/dir</span><br><span class="line">$ wget -P $MODEL_DIR http://download.tensorflow.org/models/mobilenet_v1_1.0_224_2017_06_14.tar.gz</span><br><span class="line">$ tar zxvf $MODEL_DIR/mobilenet_v1_1.0_224_2017_06_14.tar.gz -C $MODEL_DIR</span><br></pre></td></tr></table></figure>
<p>解压后的文件列表：</p>
<ul>
<li>mobilenet_v1_1.0_224.ckpt.data-00000-of-00001</li>
<li>mobilenet_v1_1.0_224.ckpt.index</li>
<li>mobilenet_v1_1.0_224.ckpt.meta</li>
</ul>
<p><strong>Export model</strong></p>
<p>如果使用 TF Slim 生成的模型，必须把模型导出成GraphDef文件，输出文件后缀是.pb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ cd $TF_MODELS_REPO_ROOT</span><br><span class="line">$ python3 export_inference_graph.py \</span><br><span class="line">    --alsologtostderr \</span><br><span class="line">    --model_name=mobilenet_v1 \</span><br><span class="line">    --image_size=224 \</span><br><span class="line">    --output_file=$MODEL_DIR/mobilenet_v1_224.pb</span><br></pre></td></tr></table></figure>
<p>这里，export_inference_graph.py 读取 mobilenet_v1 的模型代码，把它存成GraphDev文件：mobilenet_v1_224.pb</p>
<p><strong>Retrieve output node names</strong></p>
<p>我们需要使用 summarize_graph 工具获取 pb 文件的output_node.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cd $TENSORFLOW_REPO_ROOT</span><br><span class="line">$ bazel build tensorflow/tools/graph_transforms:summarize_graph</span><br><span class="line">$ bazel-bin/tensorflow/tools/graph_transforms/summarize_graph \</span><br><span class="line">  --in_graph=$MODEL_DIR/mobilenet_v1_224.pb</span><br></pre></td></tr></table></figure>
<p>输出的结果最后一行如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--output_layer=MobilenetV1/Predictions/Reshape_1</span><br></pre></td></tr></table></figure></p>
<p><strong>Freeze graph</strong></p>
<p>在模型能使用前，需要freeze graph，把 variable 转化成 constant。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ bazel build tensorflow/python/tools:freeze_graph</span><br><span class="line">$ bazel-bin/tensorflow/python/tools/freeze_graph \</span><br><span class="line">      --input_graph=$MODEL_DIR/mobilenet_v1_224.pb \</span><br><span class="line">      --input_checkpoint=$MODEL_DIR/mobilenet_v1_1.0_224.ckpt \</span><br><span class="line">      --input_binary=true --output_graph=$MODEL_DIR/frozen_mobilenet_v1_1.0_224.pb \</span><br><span class="line">      --output_node_names=MobilenetV1/Predictions/Reshape_1</span><br></pre></td></tr></table></figure>
<p>这里的 input_checkpoint 不是一个 ckpt 文件名，而是一系列 ckpt 文件的公共前缀，这里是: mobilenet_v1_1.0_224.ckpt.<br>output_node_names 来自上一步的输出。</p>
<p><strong>convert format to tflite</strong></p>
<p>上一步生成的 frozen_mobilenet_v1_1.0_224.pb 并不是 tensorflow lite 格式，需要进一步转化，用到工具 toto.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ bazel build tensorflow/contrib/lite/toco:toco</span><br><span class="line">$ bazel-bin/tensorflow/contrib/lite/toco/toco \</span><br><span class="line">  --input_file=$MODEL_DIR/frozen_mobilenet_v1_1.0_224.pb \</span><br><span class="line">  --input_format=TENSORFLOW_GRAPHDEF  --output_format=TFLITE \</span><br><span class="line">  --output_file=$MODEL_DIR/mobilenet_v1_1.0_224.tflite --inference_type=FLOAT \</span><br><span class="line">  --input_type=FLOAT --input_arrays=input \</span><br><span class="line">  --output_arrays=MobilenetV1/Predictions/Reshape_1 --input_shapes=1,224,224,3</span><br></pre></td></tr></table></figure>
<p>output_arrays 和 freeze graph 时的 output_node_names 一致， input_arrays 要通过 tensorboard 查看。<br>input_type 和 inference_type 应设置成 FLOAT，但如果使用量化的模型，可设置成 QUANTIZED。模型在训练的时候要标记 “fake quantization” 结点，<br>否则无法量化。</p>
<p>目前 quantization 还没成功，先使用 FLOAT，参考 <a href="https://www.tensorflow.org/performance/quantization" target="_blank" rel="noopener">quantization</a> 一文。</p>
<p>错误: Squeeze op 不支持， 参考 <a href="https://github.com/tensorflow/tensorflow/issues/14761" target="_blank" rel="noopener">https://github.com/tensorflow/tensorflow/issues/14761</a><br>, 目前 mobilenet/ssd 还不支持 tflite. (Jan 4th, 2018)，可以使用 google 转好的 <a href="wget https://storage.googleapis.com/download.tensorflow.org/models/mobilenet_v1_1.0_224_frozen.tgz">v1_1.0_224</a></p>
<p>TF Lite的finetune流程的文档很多，散落在各处，主要流程参考<a href="https://github.com/tensorflow/tensorflow/tree/master/tensorflow/contrib/lite" target="_blank" rel="noopener">tf lite doc</a></p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>本文主要分析了 TF Mobile 和 TF Lite 两个框架之间的关系，基于这个两个框架的应用的架构，以及模型的转换。下一篇进入实战，看如何制作TFRecord 数据集。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://waynewolf.github.io/2018/01/04/toward-cutting-edge-realtime-detection-on-mobile-device/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wayne Wolf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wayne's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/04/toward-cutting-edge-realtime-detection-on-mobile-device/" itemprop="url">toward cutting edge realtime detection on mobile device</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-04T10:55:04+08:00">
                2018-01-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>skeleton copied from tflitecamera</li>
<li>Java APP ready</li>
<li>MobileNets/SSD porting</li>
<li>benchmarking</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://waynewolf.github.io/2018/01/03/tensorflow-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wayne Wolf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wayne's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/03/tensorflow-1/" itemprop="url">tensorflow 1</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-03T21:48:53+08:00">
                2018-01-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>AI 的烈火烧遍全球，作为程序猿一枚，自然不能坐视不理。趁着 tensorflow lite 刚发布之际，趁热打铁，学习一下这个呼声颇高的框架。本文使用的版本：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tensorflow: 136697ecdc64b5171522fb7f89cfe51a02f0f1c1@master, (1.4.1之后的一个commit)</span><br><span class="line">bazel: 0.8.1</span><br></pre></td></tr></table></figure></p>
<h2 id="完善的示例"><a href="#完善的示例" class="headerlink" title="完善的示例"></a>完善的示例</h2><p>例子散落在源码中，要编译这些例子需要了解一些 bazel 的知识。本人对 bazel 比较抵触，但为了弄懂 tensorflow 代码的组织，也还是看了一些 bazel 资料，需要弄懂 WORKSPACE, BUILD, RULE, *.bzl 等文件及概念。</p>
<h2 id="丰富的教程和文档"><a href="#丰富的教程和文档" class="headerlink" title="丰富的教程和文档"></a>丰富的教程和文档</h2><p>tensorflow 网站上的API文档，教程，源码库中的示例程序非常完备很齐整，找资料不会太费劲。社区很活跃，不像学术派的caffe，似乎更新很慢。</p>
<h2 id="完善的工具"><a href="#完善的工具" class="headerlink" title="完善的工具"></a>完善的工具</h2><p>常规的模型导入，导出，转换的python工具，还有比较惊艳的 tensorboard. 在训练 caffe 模型时，通过 python 脚本分析日志文件，输出各种图表，不够直观。而tensorboard 把这件事情做的很美观简洁。</p>
<h2 id="tensorflow-serving"><a href="#tensorflow-serving" class="headerlink" title="tensorflow serving"></a>tensorflow serving</h2><p>google 为了做cloud生意也是拼了，怎样传输模型也替你想好了，tensorflow serving 有一整套工具和API帮你实现这一步。</p>
<h2 id="不同层级的API并存"><a href="#不同层级的API并存" class="headerlink" title="不同层级的API并存"></a>不同层级的API并存</h2><p>tensorflow 官方教程是从最基础的 API 讲起，教你怎么创建 Variable, 怎么创建 Op，怎么构建 Graph，这些是最核心的功能，在 core 包中。而用过 Caffe 的人都知道，直接在这一层API上实现网络各层是比较繁琐的，于是有 layer API。而显然 google 还有其他团队在研究网络算法打榜，在此核心之上开发了 TF Slim 库，贡献给了 TF, 这块代码在 contrib 包中。使用 TF Slim 的好处在于 google 基于这个框架发布了很多现成的模型。</p>
<p>同时，TF 核心也发布了在我看来比 TF Slim 更上层的 Estimator API，可以灵活切换不同的模型进行比较。</p>
<p>除此之外，跨平台的 keras API 也被集成到了 tensorflow 的 core 中，对 keras 熟悉的人，可以从这一层 API 开始。本人对 keras 并不感冒，因此没有太关注。</p>
<p>对于从 Caffe 切换过来的人来说，TF Slim 是一个不错的切入点，从这一层API开始比较顺理成章，不会写很多冗余代码，同时也保留了一定的灵活性，还有google已经训练好的基础模型作为起点。不过TF Slim 位于 contrib，未来能不能进入 core，并不清晰，况且core 中有 layer API 和它相似。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>本文对 tensorflow 和几个 API 作了简单的小结，下一篇看看 TF Mobile 和 TF Lite 两个框架。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://waynewolf.github.io/2018/01/03/hexo-101/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wayne Wolf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wayne's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/03/hexo-101/" itemprop="url">hexo 101</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-03T21:29:24+08:00">
                2018-01-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a></li>
<li><a href="https://hexo.io/docs/" target="_blank" rel="noopener">hexo documentation</a></li>
<li><a href="https://qiutc.me/post/%E4%BD%BF%E7%94%A8hexo-github%E6%90%AD%E5%BB%BA%E9%9D%99%E6%80%81%E5%8D%9A%E5%AE%A2.html" target="_blank" rel="noopener">hexo and github</a></li>
<li><a href="https://github.com/iissnan/hexo-theme-next" target="_blank" rel="noopener">hexo themes next</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://waynewolf.github.io/2017/09/10/rc-bt-car/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wayne Wolf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wayne's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/10/rc-bt-car/" itemprop="url">智能小车</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-10T00:00:13+08:00">
                2017-09-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>前段时间心血来潮，给小朋友做了个智能小车。接下来有更有意思的事情要做，这个项目先放一下，有机会再拾起做更炫的东西！</p>
<h2 id="展示"><a href="#展示" class="headerlink" title="展示"></a>展示</h2><p><img src="/images/post/2017-09-09/1.jpg" alt="蓝牙小车"></p>
<p><img src="/images/post/2017-09-09/2.png" alt="手机控制界面"></p>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>代码公布在 <a href="https://bitbucket.org/waynewolf/suntoy" target="_blank" rel="noopener">bitbucket</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://waynewolf.github.io/2017/09/09/transfer-blog-to-hexo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wayne Wolf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wayne's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/09/transfer-blog-to-hexo/" itemprop="url">transfer blog to hexo</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-09T22:39:32+08:00">
                2017-09-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>博客站迁移至hexo，发文纪念。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://waynewolf.github.io/2014/07/10/surfaceflinger-and-hwcomposer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wayne Wolf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wayne's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/07/10/surfaceflinger-and-hwcomposer/" itemprop="url">surfaceflinger and hwcomposer</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-07-10T20:26:03+08:00">
                2014-07-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>In the beginning, people believes that GPU composition is fast and power effiecent compared with CPU composition. Then, people find that in most usage scenarios, GPU can be kept sleep with the introduction of more display planes. This is where HWComposer comes into play. It is linked into SurfaceFlinger as a library, and works as a judge to decide when to offload work from GPU to display hardware.</p>
<h2 id="General-flow"><a href="#General-flow" class="headerlink" title="General flow"></a>General flow</h2><pre>
handleMessageRefresh
     |—> preComposition
     |—> rebuildLayerStacks
     |—> setUpHWComposer
          |—> HWComposer::createWorkList <== hwc="" structures="" are="" allocated="" |—=""> Layer::setGeometry()
          |—  set per frame data
          |—  HWComposer::prepare
               |—> hwc prepare
     |—> doComposition
          |---- skip composition on external display if condition meets
          |—> doDisplayComposition
          |    |—> doComposeSurfaces
          |     |—> DisplayDevice::swapBuffers
          |          |—> eglSwapBuffers
          |          |—> FramebufferSurface::advanceFrame
          |—> DisplayDevice::flip(…)     <== just="" update="" statistics="" count="" |--=""> Call DisplayDevice::compositionComplete(), notify each display
               |--> DisplaySurface::compositionComplete()
                    |--> FramebufferSurface::compositionComplete()
                         |--> HWComposer::fbCompositionComplete()
                              |--> NoOP if HWC >= 1.1
                              |--> used only in framebuffer device case.
          |—> postFrameBuffer
               |—> HWComposer::commit
                    |—> hwc set
                    |—> update retireFenceFd of hwc_display_contents_1
               |—> DisplayDevice::onSwapBuffersCompleted
                    |—> FramebufferSurface::onFrameComitted
               |—> Layer::onLayerDisplayed
               |—   update some statistics
     |—> postComposition 
</==></==></pre>

<h3 id="Recap-of-the-draw-a-frame-flow"><a href="#Recap-of-the-draw-a-frame-flow" class="headerlink" title="Recap of the draw-a-frame flow"></a>Recap of the draw-a-frame flow</h3><ul>
<li>SurfaceFlinger::setUpHWComposer<ul>
<li>beginFrame</li>
<li>hwc prepare</li>
<li>prepareFrame</li>
</ul>
</li>
<li>DisplayDevice::swapBuffers<ul>
<li>eglSwapBuffer</li>
<li>advanceFrame</li>
</ul>
</li>
<li>DisplayDevice::onSwapBuffers<ul>
<li>hwc set</li>
<li>onFrameComitted</li>
</ul>
</li>
</ul>
<h2 id="hwc-prepare"><a href="#hwc-prepare" class="headerlink" title="hwc prepare"></a>hwc prepare</h2><p>One of the major interfaces of hwc, decision is made in this phase if a layer should belended by GPU or display. Generally speaking, a layer that can be blended by display should be marked as HWC_OVERLAY, other layers marked as HWC_FRAMEBUFFER, though other complicated cases exist.</p>
<h2 id="hwc-set"><a href="#hwc-set" class="headerlink" title="hwc set"></a>hwc set</h2><p>Another major interface of hwc, hwc set callback is used to replace eglSwapBuffers for frames with mixed GLES and HWC layers.<br>Before hwc set happens, GLES layers already composed to framebuffer target, while not the other layers marked as HWC_OVERLAY. These HWC_OVERLAY layers and framebuffer tareget will be sent to hardware for blend. On my platform, in the parameters of hwc set, the Displays is 3，which includes 0 (primary display)，1(external display - like HDMI)，2(virtual display), mLists contains all the layers of all displays. The layers in a display is called layer<br>stack.</p>
<h2 id="Events-from-HWC-to-SF"><a href="#Events-from-HWC-to-SF" class="headerlink" title="Events from HWC to SF"></a>Events from HWC to SF</h2><p>Setup SF callback to HWC in HWComposer constructor</p>
<pre><code>mHwc-&gt;registerProcs(mHwc, &amp;mCBContext-&gt;procs);
</code></pre><p>hotplug:</p>
<pre><code>HWC -&gt; HWComposer::hook_hotplug -&gt; HWComposer::hotplug -&gt; SurfaceFlinger::onHotplugReceived
</code></pre><p>hardware vsync:</p>
<pre><code>HWC -&gt; HWComposer::hook_vsync -&gt; HWComposer::vsync -&gt; SurfaceFlinger::onVSyncReceived
</code></pre><p>Do not confuse these two callbacks with similar functions in EventThread, like EventThread::onHotplugReceived and EventThread::onVsyncEvent, these functions are used to notify client. </p>
<h2 id="How-layer-maps-to-plane"><a href="#How-layer-maps-to-plane" class="headerlink" title="How layer maps to plane"></a>How layer maps to plane</h2><p>The process that software layers map to display plane is driver and framework dependent, and different between implementations. PVR and GEN are lot diffrent. On PVR，DRM pageflip ioctl is not used, dc_plane_ctx structure is allocated instead，specific dc_device_post function is called to parse parameter to kernel. No more detailed explanation here, but for GEN which uses drm and i915 open source implementation, more articles will be written later.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://waynewolf.github.io/2014/06/22/surfaceflinger-and-client/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wayne Wolf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wayne's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/06/22/surfaceflinger-and-client/" itemprop="url">surfaceflinger and client</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-06-22T18:43:49+08:00">
                2014-06-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>SurfaceFlinger is the composition and display manager of android, it mainly plays two roles in the system:</p>
<ul>
<li>Surface composition</li>
<li>Buffer allocation on behalf of clients, interacts with clients through Binder interface</li>
</ul>
<p>This article is based on KitKat 4.4.2.</p>
<h2 id="How-client-draws-UI"><a href="#How-client-draws-UI" class="headerlink" title="How client draws UI"></a>How client draws UI</h2><p>ISurfaceComposer is the interface to talk to SurfaceFlinger, there’re two ways to get ISurfaceComposer interface in Client:</p>
<pre><code>sp&lt;ISurfaceComposer&gt; composer;
composer = ComposerService::getComposerService();
</code></pre><p>or</p>
<pre><code>getService(&quot;SurfaceFlinger&quot;, &amp;composer);
</code></pre><p>ISurfaceComposerClient is the interface to create Surface. To get ISurfaceComposerClient interface, use the ISurfaceComposer instance returned above:</p>
<pre><code>sp&lt;ISurfaceComposerClient&gt; composerClient = composer-&gt;createConnection();
</code></pre><p>The above two methods can be combined in single step:</p>
<pre><code>sp&lt;SurfaceComposerClient&gt; composerClient = new SurfaceComposerClient;
</code></pre><p>To operate on Surface, you have to get SurfaceControl first, simply call createSurface on the SurfaceComposerClient instance:</p>
<pre><code>sp&lt;SurfaceControl&gt; surfaceControl = composerClient-&gt;createSurface();
</code></pre><p>And call getSurface on SurfaceControl instance, you can finally get Surface:</p>
<pre><code>sp&lt;Surface&gt; surface = surfaceControl-&gt;getSurface();
</code></pre><p>Get buffer to draw:</p>
<pre><code>int Surface::lock(ANativeWindow_Buffer* outBuffer, ARect* inOutDirtyBounds);
</code></pre><p>Draw on surface with whatever method you want.</p>
<p>Complete drawing by calling:</p>
<pre><code>int Surface::unlockAndPost();
</code></pre><p>If some operations need atomic transaction, just wrap them inside:</p>
<pre><code>SurfaceComposerClient::openGlobalTransaction();
...
SurfaceComposerClient::closeGlobalTransaction();
</code></pre><h2 id="BufferQueue-and-Consumer-Provider"><a href="#BufferQueue-and-Consumer-Provider" class="headerlink" title="BufferQueue and Consumer/Provider"></a>BufferQueue and Consumer/Provider</h2><p>BufferQueue plays a central role in GraphicBuffer exchange process, two roles which are consumer and provider are designed to distinguish different entity and intension.<br>The producer of a BufferQueue can</p>
<pre><code>queueBuffer
dequeueBuffer
</code></pre><p>The consumer of a BufferQueue can</p>
<pre><code>acquireBuffer
releaseBuffer
</code></pre><p>Back to BufferQueue, usually client application create Surface, it’s provider end of a BufferQueue, SurfaceFlinger acts as consumer of the Surface provided by client. However, SurfaceFlinger also acts as provider as regard to FrameBufferSurface, which is consumed by display.</p>
<p>These APIs support android native sync to manage concurrency. Android native sync is introduced in 4.x.x. It’s a framework used by native code, while at the same time, graphic drivers haver to implement correspondance interface. Android sync is out of the scope of this article.</p>
<h2 id="Drawing-a-frame"><a href="#Drawing-a-frame" class="headerlink" title="Drawing a frame"></a>Drawing a frame</h2><h3 id="General-flow"><a href="#General-flow" class="headerlink" title="General flow"></a>General flow</h3><pre>
handleMessageRefresh
     |—> preComposition
     |—> rebuildLayerStacks
     |—> setUpHWComposer
          |—> HWComposer::createWorkList <== hwc="" structures="" are="" allocated="" |—=""> Layer::setGeometry()
          |—  set per frame data
          |—  HWComposer::prepare
               |—> hwc prepare
     |—> doComposition
          |---- skip composition on external display if condition meets
          |—> doDisplayComposition
          |    |—> doComposeSurfaces
          |     |—> DisplayDevice::swapBuffers
          |          |—> eglSwapBuffers
          |          |—> FramebufferSurface::advanceFrame
          |—> DisplayDevice::flip(…)     <== just="" update="" statistics="" count="" |--=""> Call DisplayDevice::compositionComplete(), notify each display
               |--> DisplaySurface::compositionComplete()
                    |--> FramebufferSurface::compositionComplete()
                         |--> HWComposer::fbCompositionComplete()
                              |--> NoOP if HWC >= 1.1
                              |--> used only in framebuffer device case.
          |—> postFrameBuffer
               |—> HWComposer::commit
                    |—> hwc set
                    |—> update retireFenceFd of hwc_display_contents_1
               |—> DisplayDevice::onSwapBuffersCompleted
                    |—> FramebufferSurface::onFrameComitted
               |—> Layer::onLayerDisplayed
               |—   update some statistics
     |—> postComposition 
</==></==></pre>

<h3 id="doComposeSurfaces"><a href="#doComposeSurfaces" class="headerlink" title="doComposeSurfaces"></a>doComposeSurfaces</h3><p>handleMessageRefresh -&gt; doComposition -&gt; doDisplayComposition -&gt; doComposeSurfaces</p>
<ul>
<li>Preparation work: <ul>
<li>If GLES and hwc compositing, clear frame buffer target first </li>
<li>If GLES only, drawWarmHole first</li>
</ul>
</li>
<li>Render layers to framebuffer<ul>
<li>For all layers if using hwc<ul>
<li>do nothing if HWC_OVERLAY layer, display hardware will blend the layer</li>
<li>render with opengl if HWC_FRAMEBUFFER layer, call layer-&gt;draw()</li>
<li>set the layer’s acquireFence</li>
</ul>
</li>
<li>For all layers if no hwc<ul>
<li>just render with OpenGL, call layer-&gt;draw()</li>
</ul>
</li>
</ul>
</li>
<li>Now all the GLES layers are drawn on frame buffer target, waiting to swapBuffers</li>
</ul>
<p>HWC related topic will be written in another article.</p>
<h3 id="How-FrameBufferSurface-and-eglSwapBuffers-interact"><a href="#How-FrameBufferSurface-and-eglSwapBuffers-interact" class="headerlink" title="How FrameBufferSurface and eglSwapBuffers interact"></a>How FrameBufferSurface and eglSwapBuffers interact</h3><p>In SurfaceFlinger::init, the mDisplaySurface in DisplayDevice comes from the same BufferQueue as EGLSurface, look at the code </p>
<pre><code>bq = new BufferQueue(new GraphicBufferAlloc());
fbs = new FramebufferSurface(…, bq);
hw = new DisplayDevice(…, fbs, bq, …);
mDisplays.add(…,hw);
</code></pre><p>So now EGL can swap to the FrameBufferSurface, because the EGLSurface is the provider end of the same BufferQueue which hosts FrameBufferSurface.<br>The layer represented by the frame buffer target is tracked by DisplayDevice::framebufferTarget, ANativeWindow and ANativeWindowBuffer is the interface used by EGL to access the buffer allocated in SurfaceFlinger. Basically flow is:</p>
<p>swap to DisplayDevice::mSurface, DisplayDevice::mNativeWindow influenced too -&gt; BufferQueue::queueBuffer -&gt; FramebufferSurface::onFrameAvailable -&gt; HWComposer::fbPost -&gt; HWComposer::setFramebufferTarget -&gt; get framebuffer target fram handle parameter -&gt; disp.framebufferTarget.handle = disp.fbTargetHandle;</p>
<pre><code>Stack trace: FramebufferSurface::onFrameAvailable (24 frames)
...
#02  pc 0002dffa  /system/lib/libgui.so (android::BufferQueue::ProxyConsumerListener::onFrameAvailable()+74)
#03  pc 00030ca9  /system/lib/libgui.so (android::BufferQueue::queueBuffer(int, android::IGraphicBufferProducer::QueueBufferInput const&amp;, android::IGraphicBufferProducer::QueueBufferOutput*)+2425)
#04  pc 000481cf  /system/lib/libgui.so (android::Surface::queueBuffer(ANativeWindowBuffer*, int)+559)
#05  pc 000470c9  /system/lib/libgui.so (android::Surface::hook_queueBuffer(ANativeWindow*, ANativeWindowBuffer*, int)+41)
...
#17  pc 0001e895  /system/lib/libutils.so (android::Looper::pollOnce(int, int*, int*, void**)+53)
#19  pc 00022a67  /system/lib/libsurfaceflinger.so (android::SurfaceFlinger::run()+39)
...
#22  pc 00000a02  /system/bin/surfaceflinger
</code></pre><p>To get clear understanding of the process and the role, reference to this picture:</p>
<p><img src="/images/post/surfaceflinger-as-consumer-and-producer.png" alt="surfaceflinger as consumer and producer"></p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><ol>
<li>Surface dequeueBuffer eventually works on BuffferQueue in SF, Surface is provider, SurfaceFlingerConsumer is consumer</li>
<li>GraphicBuffer in allocated for Surface to draw.</li>
<li>Surface queueBuffer eventually works on BufferQueue in SF, Layer::onFrameAvailable called.</li>
<li>SurfaceFlingerConsumer::updateTexImage bind EGLImage as texture</li>
<li>Layer::onDraw draws to the BufferQueue of FramebufferSurface, here egl is provider, FramebufferSurface is consumer</li>
<li>FramebufferSurface::onFrameAvailable -&gt; HWComposer::fbPost -&gt; HWComposer::setFramebufferTarget</li>
<li>All layers prepared, sent to HWC</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="Wayne Wolf" />
          <p class="site-author-name" itemprop="name">Wayne Wolf</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">17</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/waynewolf" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/u/5658622153" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                    
                      Weibo
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-block">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://hexo.io/" title="Hexo" target="_blank">Hexo</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.sina.com.cn" title="Sina" target="_blank">Sina</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.facebook.com" title="Facebook" target="_blank">Facebook</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2013 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Wayne Wolf</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
